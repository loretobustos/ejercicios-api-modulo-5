<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Static Template</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-dark text-white">
    <header>
      <h1>Conversor de monedas Nacional</h1>
      <hr class="text-info" />
    </header>
    <main class="bg-secondary px-5 py-3 rounded">
      <div>
        <h3>Pesos CLP</h3>
        <input placeholder="Ingrese el monto en CLP" class="form-control" />
      </div>

      <div>
        <h6>Moneda a convertir:</h6>
        <select class="moneda-select form-select">
          <option disabled selected>Seleccione moneda</option>
          <option value="dolar">Dolar</option>
          <option value="uf">UF</option>
        </select>
      </div>
      <div>
        <button class="btn btn-info w-100 text-white fw-bold">Buscar</button>
      </div>
      <div>
        <canvas id="myChart"></canvas>
        <h5><span>...</span></h5>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const pesosInput = document.querySelector("input");
      const monedaSelect = document.querySelector(".moneda-select");
      const btn = document.querySelector("button");
      const span = document.querySelector("span");
      const urlBase = "https://mindicador.cl/api";
      let myChart = null;

      btn.addEventListener("click", async () => {
        const { value: pesos } = pesosInput;
        const { value: monedaSelected } = monedaSelect;

        const valorDeLaMoneda = await search(monedaSelected);
        const valorFinal = (pesos / valorDeLaMoneda).toFixed(2);
        span.innerHTML = `Resultado: $${valorFinal}`;
      });

      async function search(moneda) {
        try {
          const res = await fetch(`${urlBase}/${moneda}`);
          const data = await res.json();
          const { serie } = data;
          const datos = createDataToChart(serie.slice(0, 10).reverse());

          if (myChart) {
            myChart.destroy();
          }

          renderGrafica(datos);
          const [{ valor: valorDeLaMoneda }] = serie;
          return valorDeLaMoneda;
        } catch (error) {
          alert("oh oh...");
          console.log(error);
        }
      }

      function renderGrafica(data) {
        const config = {
          type: "line",
          data,
        };
        const canvas = document.getElementById("myChart");
        canvas.style.backgroundColor = "white";
        if (myChart) {
          myChart.destroy();
        }
        myChart = new Chart(canvas, config);
      }

      function createDataToChart(serie) {
        const labels = serie.map(({ fecha }) => formatDate(fecha));
        const data = serie.map(({ valor }) => valor);
        const datasets = [
          {
            label: "Historial últimos 10 días",
            borderColor: "rgb(255, 99, 132)",
            data,
          },
        ];
        return { labels, datasets };
      }

      function formatDate(date) {
        date = new Date(date);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${year}-${month}-${day}`;
      }

    </script>

    <style>
      * {
        text-align: center;
      }

      body {
        height: 80vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      main div {
        margin-bottom: 15px;
      }
    </style>
  </body>
</html>
